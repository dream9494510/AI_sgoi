<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>探索美食地圖</title>
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    
    body {
      font-family: "Noto Sans TC", sans-serif;
      background-color: #E0D5AD;
      color: #5B584F;
    }
    
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
    
    .material-symbols-outlined.filled {
      font-variation-settings: 'FILL' 1;
    }
    
    #map {
      width: 100% !important;
      height: 100% !important;
      background-color: #f0f0f0;
    }
    
    .main-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }
    
    .map-wrapper {
      flex: 1;
      width: 100%;
      position: relative;
      overflow: hidden;
    }
    
    .top-panel {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10;
      padding: 1rem;
      padding-bottom: 2rem;
      background: linear-gradient(to bottom, rgba(255,255,255,0.3), transparent);
      pointer-events: none;
    }
    
    .top-panel > * {
      pointer-events: auto;
    }
    
    .bottom-panel {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 10;
      background: linear-gradient(to top, rgba(224,213,173,0.95), transparent);
      padding: 1rem;
      pointer-events: none;
    }
    
    .bottom-panel > * {
      pointer-events: auto;
    }

    .overflow-x-auto::-webkit-scrollbar {
      display: none;
    }

    .shadow-soft {
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    /* 自定義顏色變數 */
    .bg-brand-green {
      background-color: #92A78C;
    }

    .text-brand-green {
      color: #92A78C;
    }

    .bg-brand-green\/10 {
      background-color: rgba(146, 167, 140, 0.1);
    }

    .bg-brand-yellow\/30 {
      background-color: rgba(247, 205, 130, 0.3);
    }

    .text-brand-orange {
      color: #F7A640;
    }

    .text-brand-dark {
      color: #5B584F;
    }

    .text-brand-dark\/60 {
      color: rgba(91, 88, 79, 0.6);
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="map-wrapper">
      <div id="map"></div>
      
      <div class="top-panel space-y-3">
        <div class="flex items-center justify-between">
          <button class="text-brand-dark flex size-11 shrink-0 items-center justify-center bg-white/80 rounded-full backdrop-blur-sm shadow-soft hover:bg-white transition">
            <span class="material-symbols-outlined text-2xl">arrow_back</span>
          </button>
          <h2 class="text-brand-dark text-lg font-bold">探索美食地圖</h2>
          <button class="text-brand-dark flex size-11 shrink-0 items-center justify-center bg-white/80 rounded-full backdrop-blur-sm shadow-soft hover:bg-white transition">
            <span class="material-symbols-outlined text-2xl">tune</span>
          </button>
        </div>
        
        <div>
          <div class="flex w-full items-stretch rounded-full h-12 bg-white/80 shadow-lg backdrop-blur-sm overflow-hidden">
            <div class="flex items-center justify-center pl-4 text-gray-600">
              <span class="material-symbols-outlined text-2xl">search</span>
            </div>
            <input id="searchInput" class="flex w-full min-w-0 flex-1 bg-transparent text-gray-700 focus:outline-none placeholder:text-gray-400 px-3 text-base" placeholder="搜尋餐廳、料理..." value=""/>
          </div>
        </div>
        
        <div class="flex gap-2.5 overflow-x-auto pb-2 -mx-1 px-1" style="scrollbar-width: none; -ms-overflow-style: none;">
          <button class="flex h-10 shrink-0 items-center justify-center gap-x-1.5 rounded-full bg-brand-green text-white pl-4 pr-5 shadow-soft hover:shadow-lg transition category-btn" data-index="0">
            <span class="material-symbols-outlined filled text-xl">restaurant</span>
            <p class="text-sm font-medium">全部</p>
          </button>
          <button class="flex h-10 shrink-0 items-center justify-center gap-x-1.5 rounded-full bg-white/80 text-brand-dark pl-4 pr-5 backdrop-blur-sm shadow-soft hover:shadow-lg transition category-btn" data-index="1">
            <span class="material-symbols-outlined text-xl">spa</span>
            <p class="text-sm font-medium">健康餐</p>
          </button>
          <button class="flex h-10 shrink-0 items-center justify-center gap-x-1.5 rounded-full bg-white/80 text-brand-dark pl-4 pr-5 backdrop-blur-sm shadow-soft hover:shadow-lg transition category-btn" data-index="2">
            <span class="material-symbols-outlined text-xl">sell</span>
            <p class="text-sm font-medium">平價</p>
          </button>
          <button class="flex h-10 shrink-0 items-center justify-center gap-x-1.5 rounded-full bg-white/80 text-brand-dark pl-4 pr-5 backdrop-blur-sm shadow-soft hover:shadow-lg transition category-btn" data-index="3">
            <span class="material-symbols-outlined text-xl">groups</span>
            <p class="text-sm font-medium">適合聚餐</p>
          </button>
          <button class="flex h-10 shrink-0 items-center justify-center gap-x-1.5 rounded-full bg-white/80 text-brand-dark pl-4 pr-5 backdrop-blur-sm shadow-soft hover:shadow-lg transition category-btn" data-index="4">
            <span class="material-symbols-outlined text-xl">local_cafe</span>
            <p class="text-sm font-medium">咖啡廳</p>
          </button>
        </div>
      </div>
      
      <div class="bottom-panel">
        <div class="flex justify-end px-4 pb-2 mb-2">
          <button class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-14 bg-brand-green text-white text-base font-bold shadow-lg min-w-0 gap-3 px-6 hover:bg-opacity-90 transition">
            <span class="material-symbols-outlined">format_list_bulleted</span>
            <span>列表模式</span>
          </button>
        </div>
        <div id="restaurant-list" class="flex gap-3 overflow-x-auto pb-6 -mx-4 px-4 pt-2" style="scrollbar-width: none; -ms-overflow-style: none;">
        </div>
      </div>
    </div>
  </div>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDTFcNhyatB-rVRHHX8qjY5tggMZc1Reeg&callback=initMap&libraries=places&language=zh-TW"></script>

  <script>
    const API_URL = 'http://localhost:5001/api';
    let map;
    let markers = [];
    let restaurants = [];
    let selectedCategory = '全部';
    let currentInfoWindow = null;
    let isLoading = false;

    function initMap() {
      console.log("正在初始化地圖...");
      const nkust = { lat: 22.6360, lng: 120.2839 };

      map = new google.maps.Map(document.getElementById('map'), {
        center: nkust,
        zoom: 15,
        styles: [{featureType: 'poi', elementType: 'labels', stylers: [{visibility: 'off'}]}],
        mapTypeControl: false,
        fullscreenControl: false,
        streetViewControl: false,
        zoomControl: true,
        gestureHandling: 'greedy'
      });

      map.addListener('drag', () => {
        if (currentInfoWindow) currentInfoWindow.close();
      });

      console.log("地圖初始化成功！");
      loadRestaurants();
    }

    async function loadRestaurants(category = null) {
      try {
        setLoadingState(true);
        const targetCategory = category || selectedCategory || '全部';
        console.log("加載餐廳，類別:", targetCategory);
        
        let url = API_URL + '/restaurants';
        if (targetCategory && targetCategory !== '全部') {
          url += '?category=' + encodeURIComponent(targetCategory);
        }

        const response = await fetch(url, {signal: AbortSignal.timeout(10000)});
        const data = await response.json();

        if (data.success) {
          restaurants = data.data;
          console.log('載入 ' + restaurants.length + ' 間餐廳');
          displayMarkers(restaurants);
          updateRestaurantList(restaurants);
          if (restaurants.length > 0) fitMarkersToMap();
        } else {
          alert("無法載入餐廳資料");
        }
      } catch (error) {
        console.error("載入錯誤:", error);
        alert("連接失敗！請確認後端伺服器正在運行: python map_api.py");
      } finally {
        setLoadingState(false);
      }
    }

    function setLoadingState(loading) {
      isLoading = loading;
      const searchInput = document.getElementById('searchInput');
      const listContainer = document.getElementById('restaurant-list');
      if (loading) {
        searchInput?.setAttribute('disabled', 'disabled');
        listContainer && (listContainer.style.opacity = '0.5');
      } else {
        searchInput?.removeAttribute('disabled');
        listContainer && (listContainer.style.opacity = '1');
      }
    }

    function fitMarkersToMap() {
      if (!map || markers.length === 0) return;
      const bounds = new google.maps.LatLngBounds();
      markers.forEach(marker => bounds.extend(marker.getPosition()));
      map.fitBounds(bounds, {padding: 100});
    }

    function displayMarkers(restaurantList) {
      if (!map) return;
      markers.forEach(m => m.setMap(null));
      markers = [];

      restaurantList.forEach(restaurant => {
        const marker = new google.maps.Marker({
          position: {lat: parseFloat(restaurant.latitude), lng: parseFloat(restaurant.longitude)},
          map: map,
          title: restaurant.name,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: '#92A78C',
            fillOpacity: 0.8,
            strokeColor: '#FFFFFF',
            strokeWeight: 2
          },
          animation: google.maps.Animation.DROP
        });

        marker.restaurantData = restaurant;
        marker.addListener('click', () => showRestaurantInfo(restaurant, marker));

        marker.addListener('mouseover', () => {
          marker.setIcon({path: google.maps.SymbolPath.CIRCLE, scale: 14, fillColor: '#F7CD82', fillOpacity: 1, strokeColor: '#FFFFFF', strokeWeight: 3});
        });

        marker.addListener('mouseout', () => {
          marker.setIcon({path: google.maps.SymbolPath.CIRCLE, scale: 10, fillColor: '#92A78C', fillOpacity: 0.8, strokeColor: '#FFFFFF', strokeWeight: 2});
        });

        markers.push(marker);
      });
    }

    function showRestaurantInfo(restaurant, marker) {
      if (currentInfoWindow) currentInfoWindow.close();
      const ratingStars = ''.repeat(Math.floor(restaurant.avg_rating / 2));
      const priceSymbol = '$'.repeat(restaurant.price_level);
      
      const infoContent = '<div style="padding: 12px; font-family: Noto Sans TC, sans-serif; max-width: 250px;"><h3 style="font-weight: bold; margin: 0 0 8px 0; font-size: 16px;">' + restaurant.name + '</h3><p style="color: #F7CD82; font-size: 14px; margin: 0 0 5px 0;">' + ratingStars + ' ' + restaurant.avg_rating.toFixed(1) + '</p><p style="color: #666; font-size: 13px; margin: 0 0 5px 0;">' + restaurant.category + '  ' + priceSymbol + '  ' + (restaurant.distance_km || 0).toFixed(1) + ' km</p><p style="font-size: 13px; margin: 0; color: #555;">' + (restaurant.address || '地址未提供') + '</p><button onclick="focusRestaurant(\'' + restaurant.restaurant_id + '\')" style="margin-top: 8px; padding: 6px 12px; background-color: #92A78C; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">查看詳情</button></div>';

      currentInfoWindow = new google.maps.InfoWindow({content: infoContent, maxWidth: 250});
      if (marker) currentInfoWindow.open(map, marker);
    }

    function updateRestaurantList(restaurantList) {
      const container = document.getElementById('restaurant-list');
      container.innerHTML = '';

      restaurantList.forEach(restaurant => {
        const priceSymbol = '$'.repeat(restaurant.price_level);
        const ratingStars = ''.repeat(Math.floor(restaurant.avg_rating / 2));
        const tagsHTML = restaurant.tags.map(tag => '<div class="flex items-center gap-1 rounded-full bg-brand-green/10 px-2 py-0.5"><span class="material-symbols-outlined !text-sm text-brand-green">eco</span><p class="text-xs font-medium text-brand-green">' + tag + '</p></div>').join('');

        const card = '<div class="flex flex-col w-64 shrink-0 overflow-hidden rounded-2xl bg-white shadow-soft cursor-pointer hover:shadow-lg transition-shadow" onclick="focusRestaurant(\'' + restaurant.restaurant_id + '\')"><img class="h-32 w-full object-cover" src="' + (restaurant.image_url || 'https://via.placeholder.com/256x128?text=Food') + '" alt="' + restaurant.name + '"/><div class="p-3 flex flex-col gap-1.5"><div class="flex items-start justify-between"><h3 class="font-bold text-brand-dark flex-1">' + restaurant.name + '</h3><div class="flex items-center gap-1 rounded-full bg-brand-yellow/30 px-2 py-0.5 shrink-0"><span class="material-symbols-outlined filled !text-sm text-brand-orange">star</span><p class="text-sm font-bold text-brand-orange">' + restaurant.avg_rating.toFixed(1) + '</p></div></div><p class="text-sm text-brand-dark/60">' + restaurant.category + '  ' + priceSymbol + '  ' + (restaurant.distance_km || 0).toFixed(1) + ' km</p><div class="flex gap-2 pt-1 flex-wrap">' + tagsHTML + '</div></div></div>';
        container.insertAdjacentHTML('beforeend', card);
      });
    }

    function focusRestaurant(restaurantId) {
      const restaurant = restaurants.find(r => r.restaurant_id === restaurantId);
      if (!restaurant) return;
      if (map) {
        map.panTo({lat: parseFloat(restaurant.latitude), lng: parseFloat(restaurant.longitude)});
        map.setZoom(17);
        const marker = markers.find(m => m.restaurantData?.restaurant_id === restaurantId);
        if (marker) showRestaurantInfo(restaurant, marker);
      }
    }

    document.getElementById('searchInput').addEventListener('input', async (e) => {
      const query = e.target.value.trim();
      if (!query) {
        loadRestaurants(selectedCategory);
        return;
      }

      try {
        setLoadingState(true);
        const response = await fetch(API_URL + '/search?q=' + encodeURIComponent(query), {signal: AbortSignal.timeout(10000)});
        const data = await response.json();
        if (data.success) {
          displayMarkers(data.data);
          updateRestaurantList(data.data);
          if (data.data.length > 0) fitMarkersToMap();
        }
      } catch (error) {
        console.error("搜尋失敗:", error);
      } finally {
        setLoadingState(false);
      }
    });

    document.querySelectorAll('.category-btn').forEach((button, index) => {
      button.addEventListener('click', () => {
        document.querySelectorAll('.category-btn').forEach(btn => {
          btn.className = 'flex h-10 shrink-0 items-center justify-center gap-x-1.5 rounded-full bg-white/80 text-brand-dark pl-4 pr-5 backdrop-blur-sm shadow-soft hover:shadow-lg transition category-btn';
          btn.querySelector('.material-symbols-outlined').classList.remove('filled');
        });

        button.className = 'flex h-10 shrink-0 items-center justify-center gap-x-1.5 rounded-full bg-brand-green text-white pl-4 pr-5 shadow-soft hover:shadow-lg transition category-btn';
        button.querySelector('.material-symbols-outlined').classList.add('filled');

        const categories = ['全部', '健康餐', '平價', '適合聚餐', '咖啡廳'];
        selectedCategory = categories[index];
        document.getElementById('searchInput').value = '';
        loadRestaurants(selectedCategory);
      });
    });

    console.log("地圖應用已載入");
    fetch(API_URL + '/health')
      .then(r => r.json())
      .then(d => console.log(" 後端已連接:", d))
      .catch(e => {
        console.error(" 後端未連接:", e);
        alert("無法連接到後端伺服器！請執行: python map_api.py");
      });
  </script>
</body>
</html>
